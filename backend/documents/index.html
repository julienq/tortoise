<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tortoise | A Javascript Logo interpreter with an SVG turtle</title>
    <meta charset="UTF-8">
    <style>
      body { margin: 1em auto; padding: 0; width: 854px; }
      .svg { background-color: #222; text-align: center; }
      #out { font-family: monospace; max-height: 24em; overflow: auto; }
      #cmdline { font-family: monospace; font-size: 100%; border: none;
        background-color: #ddd; }
      #cmdline:focus { outline: none; background-color: #ffe; color: #08f; }
      .cmd { color: #08f; }
      .warning { color: #f80; }
      .error { color: #ff4040; }
      #canvas { position: relative; width: 854px; height: 480px; }
      #canvas canvas { position: absolute; }
    </style>
  </head>
  <body>
    <!--
    <svg id="svg_main" width="854px" height="480px"
      viewBox="-427 -240 854 480">
      <rect id="svg_bg" x="-427" y="-240" width="854" height="480"
        fill="black"/>
      <g id="svg_fg"/>
      <path id="svg_turtle" fill="#ff4040" d="M8,0L0,-16L-8,0Z"/>
    </svg>
    -->
    <div id="canvas">
      <canvas id="canvas_bg" width="854" height="480"></canvas>
      <canvas id="canvas_fg" width="854" height="480"></canvas>
      <canvas id="canvas_active" width="854" height="480"></canvas>
    </div>
    <div id="out"><div id="out_"></div></div>
    <textarea id="cmdline" cols="80" rows="1" spellcheck="false"></textarea>
    <script src="populus.js"></script>
    <script src="logo.js"></script>
    <script src="canvas.js"></script>
    <script>

var out = document.getElementById("out_");
var cmdline = document.getElementById("cmdline");
cmdline.addEventListener("keydown", function(e) {
    if (e.keyCode === 13) {
      e.preventDefault();
      var lines = cmdline.value;
      cmdline.value = "";
      logo.print(lines, "cmd");
      lines.split("\n").forEach(eval_line);
    }
  }, false);


var MODE = "eval";

// Line being read (in case of ~ it will span several calls to eval_line)
var current_line = "";

// Eval one line of input; remove comments and ~ before passing the input line
// to be evaled (so that the tokenizer does not have to deal with comments.) In
// case of a line ending with ~, read the next line before continuing.
function eval_line(line)
{
  var m = line.match(/~$/);
  if (m) line = line.substr(0, m.index);
  current_line += line.replace(/(^|[^\\]);.*$/, "$1");
  if (!m) {
    logo[MODE === "eval" ? "eval_input" : "read_def"](current_line,
      function(error, eval_mode) {
        if (error) {
          MODE = "eval";
          if (error.error_code) {
            console.log("Error #{0}: {1}".fmt(error.error_code, error.message));
          } else {
            throw error;
          }
        } else {
          MODE = eval_mode ? "eval" : "define";
        }
        current_line = "";
      });
  }
}

function eval_script(url)
{
  populus.xhr(url, {}, "", function(req) {
    if (req.status === 200 || req.status === 0) {
      req.responseText.split("\n").forEach(eval_line);
    } else {
      populus.log("XMLHttpRequest returned status {0}", req.status);
    }
  });
}

logo.print = function(str, c)
{
  str.split("\n").forEach(function(x) {
      if (c) {
        out.appendChild(populus.html("span", { "class": c }, x));
      } else {
        out.append_text(x);
      }
      out.appendChild(populus.html("br"));
    });
  // Scroll down so that the bottom is always visible
  out.parentNode.scrollTop = out.offsetHeight;
};

logo.warn = function(warning)
{
  logo.print("Warning #{0}: {1}".fmt(warning.error_code, warning.message),
    "warning");
};

logo.init_canvas_turtle(document.getElementById("canvas_bg"),
  document.getElementById("canvas_fg"),
  document.getElementById("canvas_active"));

eval_script("library.logo");
eval_script("turtle.logo");

cmdline.focus();

    </script>
  </body>
</html>
